<!DOCTYPE html>
<!--
             Copyright (c) Alexander Battarbee 2016
             
             Permission is hereby granted, free of charge, to any person obtaining
             a copy of this software and associated documentation files (the
             "Software"), to deal in the Software without restriction, including
             without limitation the rights to use, copy, modify, merge, publish,
             distribute, sublicense, and/or sell copies of the Software, and to
             permit persons to whom the Software is furnished to do so, subject to
             the following conditions:
             
             The above copyright notice and this permission notice shall be
             included in all copies or substantial portions of the Software.
             
             THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
             EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
             MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.
             IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
             LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
             OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
             WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<html>
    <head>
        <title>FH@TBot Turtle Mode</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            html, body {
                height: 100%;
                margin: 0;
            }
            body{
                position:fixed; top: 0; right: 0;
                padding   : 0;
                margin    : 0;
                background-color: #333;
                width: 195px;
                height: 133px;
                background-image: url(hacad.png);
                width: 100%;
                height: 100%;
                color: black;
                font-size: 20px;
                overflow: hidden;
            }
            h1 {
                font-weight: normal;
                font-size: 140%;
            }
            table {
                height: 100%;
                width: 100%;
            }
            #blocklyArea {
                height: 99%;
                width: 100%;
                background: #fc9;
                text-align: center;
            }
        </style>

    </head>
    <body>
        <p>
            <button onclick="parseCode()">Parse JavaScript</button>            
            <button onclick="runInterpreter()" id="runButton" disabled="disabled">Run JavaScript </button>
        </p>
        <div id="blocklyDiv" style="height: 95%; width: 95%; padding: auto"></div>
    <xml id="toolbox" style="display: none">
        <category name="Logic">
            <category name="If">
                <block type="controls_if"></block>
                <block type="controls_if">
                    <mutation else="1"></mutation>
                </block>
                <block type="controls_if">
                    <mutation elseif="1" else="1"></mutation>
                </block>
            </category>
            <category name="Boolean">
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
        </category>
        <category name="Loops">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <field name="VAR">i</field>
                <value name="FROM">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
                <value name="BY">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_trig"></block>
            <block type="math_constant"></block>
            <block type="math_number_property"></block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
            <block type="math_modulo"></block>
            <block type="math_constrain">
                <value name="LOW">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="HIGH">
                    <block type="math_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <field name="NUM">100</field>
                    </block>
                </value>
            </block>
            <block type="math_random_float"></block>
        </category>
        <sep></sep>
        <category name="Bot Commands">
            <block type="bot_turn_left"></block>
            <block type="bot_turn_right"></block>
            <block type="bot_move_forward"></block>
            <block type="bot_move_backward"></block>
            <block type="bot_stop"></block>
            <block type="bot_run"></block>
        </category>
        <sep></sep>
        <category name="Advanced" expanded="false">
            <category name="Lists">
                <block type="lists_create_empty"></block>
                <block type="lists_create_with"></block>
                <block type="lists_repeat">
                    <value name="NUM">
                        <block type="math_number">
                            <field name="NUM">5</field>
                        </block>
                    </value>
                </block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf"></block>
                <block type="lists_getIndex"></block>
                <block type="lists_setIndex"></block>
            </category>
            <category name="Variables" custom="VARIABLE"></category>
            <category name="Functions" custom="PROCEDURE"></category>
        </category>
        <sep></sep>
        <category name="Library" expanded="false">
        </category>
    </xml>
    <script src="js/blockly.js" type="text/javascript"></script>
    <script src="js/javascript.js" type="text/javascript"></script>
    <script src="js/blocks.js" type="text/javascript"></script>
    <script src="js/msg/js/en.js" type="text/javascript"></script>
    <script src="js/acorn.js" type="text/javascript"></script>
    <script src="js/botBlocks.js" type="text/javascript"></script>
    <script>

                //Blockly Injection and positioning
                var blocklyArea = document.getElementById('blocklyArea');
                var blocklyDiv = document.getElementById('blocklyDiv');
                var workspace = Blockly.inject('blocklyDiv',
                              {toolbox: document.getElementById('toolbox'),
                            grid: {spacing: 40,
                                length: 5,
                                colour: '#ccc',
                                snap: true},
                            trashcan: true});
                //Setup XHTTP
                var xhttp = new XMLHttpRequest();
                //Setup Queue namespace
                var botQueue = "";
                //Setup the interpreter
                var jsInterpreter = null;
                function initApi(interpreter, scope) {
                    // Add an API function for the alert() block.
                    var wrapper = function (text) {
                        text = text ? text.toString() : '';
                        return interpreter.createPrimitive(alert(text));
                    };
                    interpreter.setProperty(scope, 'alert',
                            interpreter.createNativeFunction(wrapper));

                    // Add an API function for the prompt() block.
                    var wrapper = function (text) {
                        text = text ? text.toString() : '';
                        return interpreter.createPrimitive(prompt(text));
                    };
                    interpreter.setProperty(scope, 'prompt',
                            interpreter.createNativeFunction(wrapper));
                    // Add an API function for the addCommand() block.
                    var wrapper = function (text) {
                        text = text ? text.toString() : '';
                        console.log("Output from interpreter:" + text);
                        addCommand(text);
                    };
                    interpreter.setProperty(scope, 'addCommand',
                            interpreter.createNativeFunction(wrapper));
                    // Add an API function for the runBot() block.
                    var wrapper = function (text) {
                        text = text ? text.toString() : '';
                        console.log("Sending run Command");
                        runBot(text);
                    };
                    interpreter.setProperty(scope, 'runBot',
                            interpreter.createNativeFunction(wrapper));
                }
                var highlightPause = false;

                function highlightBlock(id) {
                    workspace.highlightBlock(id);
                    highlightPause = true;
                }

                //Listener for screen resizing
                var onresize = function (e) {
                    // Compute the absolute coordinates and dimensions of blocklyArea.
                    var element = blocklyArea;
                    var x = 0;
                    var y = 0;
                    do {
                        x += element.offsetLeft;
                        y += element.offsetTop;
                        element = element.offsetParent;
                    } while (element);
                    // Position blocklyDiv over blocklyArea.
                    blocklyDiv.style.left = x + 'px';
                    blocklyDiv.style.top = y + 'px';
                    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
                    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
                };
                window.addEventListener('resize', onresize, false);
                onresize();
                Blockly.svgResize(workspace);
                //Generation on change.
                function myUpdateFunction(event) {
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    document.getElementById('textarea').value = code;
                }
                workspace.addChangeListener(myUpdateFunction);

                //Execution of Code
                //Code is contained in intepreted sandbox
                function parseCode() {
                    armQueue();
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    jsInterpreter = new Interpreter(code, initApi);
                    alert('Ready to run this code:\n\n' + code);
                    document.getElementById('runButton').disabled = '';
                    //workspace.traceOn(true);
                    //workspace.highlightBlock(null);
                }

                function runInterpreter() {
                    //disable('disabled');
                    jsInterpreter.run();
                    document.getElementById('runButton').disabled = 'disabled';
                    runBot();
                }

                //QUEUE start with data, and keep adding on more.
                function armQueue() {
                    botQueue = "";
                }

                function addCommand(text) {
                    botQueue += text + ",";
                }

                /**
                 * Sends text to the bot to execute
                 * @returns {void}
                 */
                function runBot() {
                    if (botQueue !== "") {
                        xhttp.abort();
                        console.log();
                        xhttp.open("GET", "/data," + botQueue, true);
                        // xhttp.timeout = 100;
                        xhttp.send();
                        armQueue();
                    }
                }
    </script>
</body>
</html>

